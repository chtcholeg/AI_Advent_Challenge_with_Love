# Изменения в day-03-dialog по сравнению с day-02-structured-response

## Краткое описание

Проект был расширен для поддержки диалогового режима (Dialog Mode), в котором AI собирает требования через интерактивный диалог, задавая уточняющие вопросы **строго по одному**. Режимы работы AI (Normal, JSON, Dialog) теперь взаимоисключающие через enum и выбираются из выпадающего меню. Добавлен видимый скроллбар для Desktop/Web платформ в экране настроек.

## Основные изменения

### 1. Модель данных

#### `ResponseMode.kt` (новый файл)
- **Enum для режимов работы AI** с тремя вариантами:
  - `NORMAL` - стандартные разговорные ответы
  - `STRUCTURED_JSON` - ответы в строгом JSON формате
  - `DIALOG` - интерактивный сбор требований через вопросы
- Каждый режим имеет `displayName` и `description`
- Метод `fromString()` для конвертации из строки
- Режимы **взаимоисключающие** по дизайну

#### `AiSettings.kt`
**Изменения структуры:**
- **УДАЛЕНЫ** два boolean поля:
  - ~~`useStructuredResponse: Boolean`~~
  - ~~`useDialogMode: Boolean`~~
- **ДОБАВЛЕНО** одно enum поле:
  - `responseMode: ResponseMode = ResponseMode.DEFAULT`

**Новый системный промпт:**
- Добавлена константа `DIALOG_SYSTEM_PROMPT` с **строгими правилами**:
  - "Ask EXACTLY ONE question per response - NEVER ask multiple questions"
  - Запрещенные паттерны: ❌ "What is X? What is Y?"
  - Правильные паттерны: ✅ "What type of project is this for?"
  - Каждый ответ должен содержать **только один знак вопроса (?)**
  - Детальные инструкции по процессу сбора информации
  - Примеры правильного диалога один-вопрос-за-раз

**Преимущества:**
- Невозможно включить оба режима одновременно (enum)
- Компилятор проверяет exhaustive when выражения
- Легко добавить новые режимы в будущем
- Чистая архитектура без конфликтующих состояний

### 2. UI компоненты

#### `SettingsScreen.kt`
**Кардинальное изменение UI настроек:**

**УДАЛЕНЫ** два компонента:
- ~~`StructuredResponseSwitch`~~ (переключатель JSON режима)
- ~~`DialogModeSwitch`~~ (переключатель Dialog режима)

**ДОБАВЛЕН** один компонент:
- `ResponseModeSelector` - выпадающее меню (ExposedDropdownMenuBox):
  - Отображает текущий режим
  - Три опции в меню с описаниями
  - Автоматическая взаимоисключаемость
  - Динамическое описание выбранного режима под меню
  - Кастомные цвета в стиле приложения

**Добавлена прокрутка:**
- Добавлен `rememberScrollState()` для отслеживания позиции
- Добавлен `.verticalScroll(scrollState)` к Column
- Добавлен `PlatformVerticalScrollbar` справа
- Padding справа (12dp) для скроллбара

**Импорты:**
- `ResponseMode` - для работы с enum
- `PlatformVerticalScrollbar` - для платформо-зависимого скроллбара

#### `PlatformScrollbar.kt` (новая архитектура)
**Создан expect/actual паттерн для платформо-зависимого скроллбара:**

**Common (expect):**
- `PlatformScrollbar.kt` в `commonMain/presentation/components/`
- Объявляет expect функцию `PlatformVerticalScrollbar`

**Android (actual):**
- `PlatformScrollbar.android.kt` в `androidMain/presentation/components/`
- **Пустая реализация** - Android показывает скроллбар нативно

**Desktop (actual):**
- `PlatformScrollbar.desktop.kt` в `desktopMain/presentation/components/`
- Использует `VerticalScrollbar` из Compose Desktop
- Виден постоянно справа

**Web (actual):**
- `PlatformScrollbar.wasmJs.kt` в `wasmJsMain/presentation/components/`
- Использует `VerticalScrollbar` из Compose Multiplatform
- Виден постоянно справа

### 3. Бизнес-логика

#### `ChatRepositoryImpl.kt`
**Обновлена логика выбора системного промпта:**

**Было (boolean):**
```kotlin
val systemPrompt = when {
    settings.useDialogMode -> AiSettings.DIALOG_SYSTEM_PROMPT
    settings.useStructuredResponse -> settings.systemPrompt
    else -> null
}
```

**Стало (enum):**
```kotlin
val systemPrompt = when (settings.responseMode) {
    ResponseMode.DIALOG -> AiSettings.DIALOG_SYSTEM_PROMPT
    ResponseMode.STRUCTURED_JSON -> settings.systemPrompt
    ResponseMode.NORMAL -> null
}
```

**Преимущества:**
- Exhaustive when - компилятор проверит все случаи
- Невозможно забыть обработать новый режим
- Нет приоритетов - каждый режим явный
- Чище и понятнее код

#### `ChatStore.kt`
**Обновлено управление состоянием:**

**Изменения:**
- **Переименовано** поле: `currentUseStructuredResponse` → `currentResponseMode`
- **Переименован** метод: `handleStructuredResponseChange()` → `handleResponseModeChange()`
- Метод теперь принимает `ResponseMode` вместо boolean
- Использует `when (newMode)` для обработки трех режимов

**Системные сообщения:**
- `ResponseMode.STRUCTURED_JSON` → "Structured JSON response mode enabled..."
- `ResponseMode.DIALOG` → "Dialog mode enabled. AI will ask clarifying questions one at a time..."
- `ResponseMode.NORMAL` → удаляет системные сообщения

**Импорты:**
- Добавлен `ResponseMode`

#### `Koin.kt`
- Без изменений (все изменения совместимы с DI)

### 4. Функциональность

#### Новый Dialog Mode:

**Цель:**
Интерактивный сбор требований для создания технических заданий, спецификаций, документации

**Процесс:**
1. Пользователь выбирает "Dialog Mode" из выпадающего меню
2. В чат добавляется системное сообщение о включении режима
3. Пользователь делает высокоуровневый запрос: "Мне нужно техническое задание"
4. AI задает **ОДИН** вопрос за раз:
   - "What type of project is this for?"
   - Ждет ответа
   - "Great! What is the main purpose of this application?"
   - Ждет ответа
   - Продолжает последовательно
5. После сбора всей информации AI выдает полный результат

**Примеры использования:**
- Создание технических спецификаций
- Сбор требований к проекту
- Планирование архитектуры системы
- Составление документации
- Сбор бизнес-требований

#### Улучшенный UI выбора режима:

**Было (два переключателя):**
- Риск включения обоих режимов одновременно
- Неочевидна взаимоисключаемость
- Занимают много места в UI

**Стало (выпадающее меню):**
- Физически невозможно выбрать два режима
- Компактнее в UI
- Более интуитивно понятно
- Легко масштабируется при добавлении режимов

#### Скроллбар в настройках:

**Desktop/Web:**
- Виден постоянно справа
- Показывает текущую позицию прокрутки
- Можно кликать и перетаскивать
- Не перекрывает контент (padding 12dp справа)

**Android:**
- Нативный скроллбар появляется при прокрутке
- Автоматически скрывается
- Не занимает место в UI

### 5. Архитектурные улучшения

#### Преимущества enum над boolean:
1. **Type Safety**: Компилятор проверяет exhaustive when
2. **Single Source of Truth**: Один enum вместо комбинаций boolean
3. **Масштабируемость**: Легко добавить новые режимы
4. **Читаемость**: Явные имена вместо логических комбинаций
5. **Безопасность**: Невозможны конфликтующие состояния

#### Платформо-зависимый код:
- expect/actual паттерн для скроллбара
- Каждая платформа имеет оптимальную реализацию
- Общий интерфейс в common коде

## Тестирование

Проект успешно собирается на всех платформах:
- ✅ Android (Debug и Release) - с нативным скроллбаром
- ✅ Desktop (JVM) - с видимым скроллбаром
- ✅ Web (WasmJS) - с видимым скроллбаром

## Технические детали

### Зависимости
- Использует существующие зависимости
- Новых external зависимостей не добавлено

### Архитектурные решения
- MVI паттерн сохранен
- Добавлен enum для type-safe состояний
- expect/actual для платформо-специфичного UI
- Реактивное управление через StateFlow

### Безопасность
- Строгие правила в системном промпте предотвращают спам вопросов
- Валидация через enum предотвращает некорректные состояния
- Очистка истории при смене режима

## Обновления документации

### Созданы/обновлены файлы:
- `DIALOG_MODE.md` - подробное описание Dialog Mode
- `README.md` - описание всех трех режимов и выпадающего меню
- `CLAUDE.md` - обновлена архитектура с ResponseMode enum
- `DIFF_02-03.md` - этот файл с описанием изменений

## Рекомендации по использованию

### Dialog Mode:
1. Откройте Settings (⚙️)
2. Выберите "Dialog Mode" из выпадающего меню "Response Mode"
3. Начните с высокоуровневого запроса (например, "Мне нужно ТЗ")
4. Отвечайте на вопросы AI по одному
5. Дождитесь финального результата когда AI соберет всю информацию

### Structured JSON Mode:
1. Откройте Settings (⚙️)
2. Выберите "Structured JSON Response"
3. Задавайте вопросы
4. Используйте кнопку "Format" для красивого отображения

### Normal Mode:
1. Выберите "Normal Mode" для обычных разговорных ответов
2. AI будет отвечать напрямую без специального форматирования

## Ключевые улучшения

1. **Один вопрос за раз** - строгое соблюдение в Dialog Mode
2. **Взаимоисключающие режимы** - через enum, невозможны конфликты
3. **Удобный UI** - выпадающее меню вместо переключателей
4. **Видимый скроллбар** - для Desktop/Web платформ
5. **Чистая архитектура** - type-safe enum, expect/actual паттерн
6. **Масштабируемость** - легко добавить новые режимы

## Миграция с day-02

Если у вас сохранены настройки из day-02:
- `useStructuredResponse: true` → автоматически мапится в `ResponseMode.STRUCTURED_JSON`
- `useDialogMode: true` → автоматически мапится в `ResponseMode.DIALOG`
- Оба false → `ResponseMode.NORMAL`

Поля `useStructuredResponse` и `useDialogMode` удалены из кодовой базы, но совместимость обеспечена через `ResponseMode.fromString()`.
