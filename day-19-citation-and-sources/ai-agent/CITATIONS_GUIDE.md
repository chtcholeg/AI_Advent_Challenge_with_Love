# Руководство по цитатам и источникам

## Обзор

AI Agent теперь отображает не только ссылки на источники, но и фактические цитаты (фрагменты текста) из документов при использовании RAG.

## Как это работает

### 1. Включите RAG
В настройках AI Agent включите режим RAG и укажите путь к индексу документов.

### 2. Задайте вопрос
Когда вы задаете вопрос, система:
1. Ищет релевантные фрагменты в индексе
2. Извлекает текст этих фрагментов
3. Передает контекст в AI модель
4. Сохраняет ссылки на источники вместе с цитатами

### 3. Просмотрите ответ с источниками
В ответе AI вы увидите:
- **Основной текст ответа** с маркерами источников `[Источник N]`
- **Блок "Источники"** внизу сообщения (кликните для раскрытия)

### 4. Изучите цитаты
Раскрыв блок источников, вы увидите для каждого источника:
```
[N] название_файла.txt
  "Фрагмент текста из документа, который был использован для
  формирования ответа. Показывается до 300 символов..."
  Фрагмент 2/15 · Релевантность: 87%
```

## Структура отображения

```
┌─ Ответ AI ─────────────────────────────────────┐
│ Ответ на ваш вопрос с упоминаниями [Источник 1]│
│ и [Источник 2] в тексте.                        │
│                                                  │
│ ┌─ Источники (2) ▼ ──────────────────────────┐ │
│ │ [1] document.txt                            │ │
│ │   "Это цитата из первого источника..."     │ │
│ │   Фрагмент 1/5 · Релевантность: 92%        │ │
│ │                                              │ │
│ │ [2] article.md                              │ │
│ │   "А это цитата из второго источника..."   │ │
│ │   Фрагмент 3/10 · Релевантность: 85%       │ │
│ └──────────────────────────────────────────────┘ │
│ 2.4s · 1234 tokens (↑800 ↓434)                  │
└──────────────────────────────────────────────────┘
```

## Преимущества

### Проверяемость
Вы можете проверить, на основе каких конкретных фрагментов текста AI сформировал ответ.

### Контекст
Цитаты дают дополнительный контекст, который может быть полезен даже если AI уже извлек суть.

### Навигация
Клик по источнику позволяет открыть полный документ для детального изучения.

### Прозрачность
Видно, насколько релевантен каждый источник (процент соответствия запросу).

## Настройки RAG

В настройках можно управлять:
- **Режим RAG**: ON/OFF
- **Путь к индексу**: Где хранятся векторные представления документов
- **Reranking**: Двухэтапная фильтрация для улучшения качества
- **Initial Top K**: Сколько кандидатов извлечь на первом этапе (по умолчанию 10)
- **Final Top K**: Сколько источников оставить после reranking (по умолчанию 3)
- **Reranker Threshold**: Минимальная релевантность для второго этапа (по умолчанию 0.5)
- **Score Gap Threshold**: Порог падения релевантности для отсечения (по умолчанию 0.15)

## Технические детали

### SourceReference
Каждый источник содержит:
- `filePath`: Путь к документу или URL
- `chunkIndex`: Номер фрагмента в документе
- `totalChunks`: Общее количество фрагментов в документе
- `similarity`: Релевантность (0.0-1.0)
- `isUrl`: Является ли источником веб-страница
- `text`: Текст цитаты (до 300 символов в UI)

### Форматирование
- Цитаты обрезаются до 300 символов для компактности
- Полный текст доступен в `SourceReference.text`
- Цитаты отображаются в кавычках с темным фоном
- Источники сортируются по номеру (1, 2, 3...)

## Пример использования

**Вопрос**: "Как настроить MCP сервер?"

**Ответ с источниками**:
```
Для настройки MCP сервера используйте настройки [Источник 1].
Требуются параметры name, command и args [Источник 2].

Источники (2):
[1] mcp_setup.md
  "MCP (Model Context Protocol) позволяет подключать
  внешние инструменты. Настройка осуществляется через
  UI в разделе Settings → MCP Management..."
  Фрагмент 1/8 · Релевантность: 94%

[2] config_guide.md
  "Каждый MCP сервер требует: name (уникальное имя),
  command (путь к исполняемому файлу), args (аргументы
  командной строки в формате JSON)..."
  Фрагмент 5/12 · Релевантность: 88%
```

## Ограничения

- Цитаты показываются только при включенном RAG
- Максимальная длина цитаты в UI: 300 символов
- Требуется предварительная индексация документов
- Качество цитат зависит от качества chunking при индексации
