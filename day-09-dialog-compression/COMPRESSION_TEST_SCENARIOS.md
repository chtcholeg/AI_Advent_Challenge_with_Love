# Тестовые сценарии сжатия диалога

Этот документ содержит тестовые сценарии для проверки корректной работы функции сжатия диалога.

## Подготовка

Перед тестированием настройте следующие параметры:
1. Включите **Авто-суммаризацию** в Настройках
2. Установите **Порог сообщений** на **4** (минимальное значение для быстрого тестирования)
3. Включите переключатель **Сжатие истории** (для режима сжатия)

---

## Хорошие сценарии (сжатие работает эффективно)

Эти сценарии демонстрируют ситуации, когда сжатие диалога эффективно сохраняет важный контекст.

### Сценарий 1: Техническое обсуждение с чёткой темой

**Цель:** Проверить, что сжатие сохраняет основной контекст технического обсуждения.

**Сообщения для отправки:**
```
Сообщение 1: "Я создаю REST API для приложения со списком задач. Какой фреймворк порекомендуете для Python?"

Сообщение 2: "Выберу FastAPI. Как лучше всего структурировать проект?"

Сообщение 3: "Стоит ли использовать SQLAlchemy или Tortoise ORM для слоя базы данных?"

Сообщение 4: "Давайте используем SQLAlchemy. Как реализовать JWT-аутентификацию?"
```

**Ожидаемое поведение после сжатия:**
- Резюме должно содержать: REST API, приложение задач, Python, FastAPI, SQLAlchemy, JWT-аутентификация
- Следующий вопрос типа "Как защитить маршруты с помощью JWT-токена?" должен получить контекстный ответ
- ИИ должен помнить, что мы выбрали FastAPI и SQLAlchemy

**Проверочный вопрос после сжатия:**
```
"Теперь покажи структуру папок для проекта, который мы обсуждали"
```

---

### Сценарий 2: Планирование поездки (структурированная информация)

**Цель:** Проверить, что конкретные факты и решения сохраняются.

**Сообщения для отправки:**
```
Сообщение 1: "Я планирую поездку в Японию на 2 недели в апреле"

Сообщение 2: "Хочу посетить Токио, Киото и Осаку. Какой лучший маршрут?"

Сообщение 3: "Мой бюджет около 300 000 рублей без учёта перелёта. Это реалистично?"

Сообщение 4: "Меня интересует традиционная культура, храмы и японская кухня"
```

**Ожидаемое поведение после сжатия:**
- Резюме должно включать: Япония, 2 недели, апрель, города (Токио, Киото, Осака), бюджет 300 000 руб., интересы
- Последующие вопросы должны работать с этим контекстом

**Проверочный вопрос после сжатия:**
```
"На основе нашего обсуждения, предложи маршрут по дням на первые 3 дня"
```

---

### Сценарий 3: Обучающая сессия с вопросами и ответами

**Цель:** Проверить, что образовательный контекст и изученные концепции сохраняются.

**Сообщения для отправки:**
```
Сообщение 1: "Объясни, что такое рекурсия в программировании"

Сообщение 2: "Можешь показать простой пример с факториалом?"

Сообщение 3: "А как насчёт последовательности Фибоначчи с использованием рекурсии?"

Сообщение 4: "В чём проблема этого подхода для больших чисел?"
```

**Ожидаемое поведение после сжатия:**
- Резюме должно содержать: изучение рекурсии, примеры факториал/Фибоначчи, обсуждение проблем производительности
- ИИ должен помнить, что мы говорили о проблемах рекурсии

**Проверочный вопрос после сжатия:**
```
"Как можно исправить проблемы производительности, которые мы обсуждали?"
```

---

## Плохие сценарии (ограничения сжатия)

Эти сценарии показывают ситуации, где сжатие может потерять важные детали.

### Сценарий 4: Несколько несвязанных тем

**Цель:** Показать, что сжатие плохо справляется с разрозненными темами.

**Сообщения для отправки:**
```
Сообщение 1: "Какая столица Франции?"

Сообщение 2: "Как испечь печенье с шоколадной крошкой?"

Сообщение 3: "Объясни квантовую запутанность"

Сообщение 4: "Какое лучшее упражнение при боли в пояснице?"
```

**Ожидаемое поведение:**
- Резюме может быть фрагментированным или поверхностным для каждой темы
- Продолжение разговора по конкретной теме может не иметь глубины

**Проверочный вопрос после сжатия:**
```
"Можешь дать больше деталей о рецепте, который мы обсуждали?"
```
*ИИ может не помнить конкретные детали рецепта печенья*

---

### Сценарий 5: Числовые данные и конкретные значения

**Цель:** Показать, что точные числа могут быть потеряны при суммаризации.

**Сообщения для отправки:**
```
Сообщение 1: "У меня 3 сервера: СерверА с 32ГБ ОЗУ, СерверБ с 64ГБ ОЗУ, СерверВ с 16ГБ ОЗУ"

Сообщение 2: "СерверА работает на порту 8080, СерверБ на 8081, а СерверВ на 8082"

Сообщение 3: "IP-адреса: 192.168.1.10, 192.168.1.11 и 192.168.1.12 соответственно"

Сообщение 4: "СерверБ нуждается в обслуживании завтра в 15:45"
```

**Ожидаемое поведение:**
- Резюме, скорее всего, не сохранит все точные числа/IP/порты
- Критические данные конфигурации могут быть потеряны или обобщены

**Проверочный вопрос после сжатия:**
```
"Какой IP-адрес у СервераБ?"
```
*ИИ может не помнить точный IP*

---

### Сценарий 6: Обсуждение длинного кода

**Цель:** Показать, что фрагменты кода, вероятно, будут потеряны при сжатии.

**Сообщения для отправки:**
```
Сообщение 1: "Вот моя функция:
def calculate(x, y):
    if x > 100:
        return x * y * 0.9
    else:
        return x * y"

Сообщение 2: "Есть баг, когда x равен точно 100"

Сообщение 3: "Мне также нужно обработать отрицательные числа"

Сообщение 4: "Добавь логирование для отладки"
```

**Ожидаемое поведение:**
- Резюме содержит суть (функция, обсуждённые баги, функции для добавления)
- Сам код потерян
- Нельзя сослаться на конкретные строки или точную логику

**Проверочный вопрос после сжатия:**
```
"Покажи обновлённый код со всеми нашими исправлениями"
```
*ИИ не будет иметь оригинального кода для модификации*

---

## Сравнение режима добавления и режима сжатия

Для сравнения режимов выполните один и тот же сценарий дважды:

### Тест с режимом добавления (Сжатие истории = ВЫКЛ):
1. Отключите переключатель "Сжатие истории"
2. Выполните Сценарий 1
3. После порога резюме ДОБАВЛЯЕТСЯ в чат
4. Оригинальные сообщения остаются видимыми
5. Количество токенов продолжает расти

### Тест с режимом сжатия (Сжатие истории = ВКЛ):
1. Включите переключатель "Сжатие истории"
2. Выполните Сценарий 1
3. После порога история ЗАМЕНЯЕТСЯ на резюме
4. Видно только сообщение с резюме
5. Количество токенов уменьшается (достигнуто сжатие)

---

## Наблюдение за использованием токенов

С включённым режимом сжатия наблюдайте за количеством токенов до и после суммаризации:
- До сжатия: Количество токенов увеличивается с каждым сообщением
- После сжатия: Общее количество токенов должно значительно уменьшиться
- Следующее сообщение использует контекст резюме (меньше токенов запроса, чем при полной истории)

---

## Тест ручной суммаризации

Вы также можете протестировать ручную суммаризацию:

1. Проведите разговор с 5+ сообщениями
2. Откройте меню (три точки)
3. Выберите "Суммировать чат" (добавляет резюме) или "Суммировать и заменить" (сжимает)
4. Наблюдайте за разницей в поведении
