# Changelog: Day 8 → Day 9 (Dialog Compression)

This document describes all changes made between Day 8 (Counting Tokens) and Day 9 (Dialog Compression).

## Summary

Day 9 introduces **Dialog Compression** - a feature that automatically compresses long conversations by replacing the chat history with a summary, reducing token usage while preserving conversation context.

## New Feature: Dialog Compression

### Overview

The dialog compression feature allows the application to automatically summarize conversations when they reach a configurable message threshold. Users can choose between two modes:

1. **Compression Mode** (Replace History): Replaces all messages with a summary - reduces token count
2. **Append Mode** (Add Summary): Adds summary as a new message - keeps original history visible

### Benefits

- **Token Savings**: Reduces API costs by using summary instead of full conversation history
- **Context Preservation**: AI continues conversation based on summary context
- **Automatic Operation**: No manual intervention needed once configured
- **Configurable**: Users can choose between compression and append modes

---

## File Changes

### Modified Files

#### 1. `domain/model/AiSettings.kt`

**Changes:**
- Added new setting field `summarizationReplaceHistory: Boolean`
- Added constant `DEFAULT_SUMMARIZATION_REPLACE_HISTORY = true`

**Before:**
```kotlin
data class AiSettings(
    ...
    val summarizationEnabled: Boolean = DEFAULT_SUMMARIZATION_ENABLED,
    val summarizationMessageThreshold: Int = DEFAULT_SUMMARIZATION_THRESHOLD
)
```

**After:**
```kotlin
data class AiSettings(
    ...
    val summarizationEnabled: Boolean = DEFAULT_SUMMARIZATION_ENABLED,
    val summarizationMessageThreshold: Int = DEFAULT_SUMMARIZATION_THRESHOLD,
    val summarizationReplaceHistory: Boolean = DEFAULT_SUMMARIZATION_REPLACE_HISTORY
)
```

---

#### 2. `presentation/chat/ChatStore.kt`

**Changes:**
- Modified `checkAutoSummarization()` to choose between compression and append modes based on settings

**Before:**
```kotlin
private fun checkAutoSummarization() {
    val settings = settingsRepository.settings.value
    if (settings.summarizationEnabled &&
        messagesSinceLastSummarization >= settings.summarizationMessageThreshold &&
        !isSummarizing) {
        summarizeChat()
    }
}
```

**After:**
```kotlin
private fun checkAutoSummarization() {
    val settings = settingsRepository.settings.value
    if (settings.summarizationEnabled &&
        messagesSinceLastSummarization >= settings.summarizationMessageThreshold &&
        !isSummarizing) {
        // Use compress mode (replace history) or append mode based on settings
        if (settings.summarizationReplaceHistory) {
            summarizeAndReplaceChat()
        } else {
            summarizeChat()
        }
    }
}
```

---

#### 3. `presentation/settings/SettingsScreen.kt`

**Changes:**
- Added `replaceHistory` parameter to `SummarizationSettings` composable
- Added `onReplaceHistoryChange` callback
- Added "Compress History" toggle UI element

**New UI Element:**
```kotlin
Row(
    modifier = Modifier.fillMaxWidth(),
    horizontalArrangement = Arrangement.SpaceBetween,
    verticalAlignment = Alignment.CenterVertically
) {
    Column(modifier = Modifier.weight(1f)) {
        Text(
            text = "Compress History",
            style = MaterialTheme.typography.bodyLarge,
            color = colors.headerText
        )
        Text(
            text = if (replaceHistory) {
                "History will be replaced with summary (compression mode)"
            } else {
                "Summary will be added to the conversation (append mode)"
            },
            style = MaterialTheme.typography.bodySmall,
            color = colors.headerText.copy(alpha = 0.6f)
        )
    }
    Switch(
        checked = replaceHistory,
        onCheckedChange = onReplaceHistoryChange,
        ...
    )
}
```

---

### New Files

#### 1. `COMPRESSION_TEST_SCENARIOS.md`

A comprehensive test document containing:
- Setup instructions for testing compression
- **Good case scenarios** (3 scenarios where compression works well):
  - Technical Discussion with Clear Topic
  - Planning a Trip (Structured Information)
  - Learning Session with Q&A
- **Bad case scenarios** (3 scenarios showing compression limitations):
  - Multiple Unrelated Topics
  - Numerical Data and Specific Values
  - Long Code Discussion
- Instructions for comparing Append vs Compression modes
- Guidelines for observing token usage

---

### Deleted Files

#### 1. `DIFF_07-08.md`

Removed as it was replaced by `DIFF_08-09.md` for the current version.

---

## Architecture Impact

### Settings Flow
```
User toggles "Compress History" in Settings
    ↓
SettingsRepository.updateSettings(settings.copy(summarizationReplaceHistory = value))
    ↓
ChatStore observes settings changes
    ↓
On auto-summarization trigger:
    - If replaceHistory = true → summarizeAndReplaceChat()
    - If replaceHistory = false → summarizeChat()
```

### Data Flow for Compression Mode
```
Message threshold reached
    ↓
summarizeAndReplaceChat() called
    ↓
Create summarization request with SUMMARIZATION_SYSTEM_PROMPT
    ↓
Send to AI via sendMessageWithCustomSystemPrompt()
    ↓
Clear conversation history in ChatRepository
    ↓
Initialize repository with summary as context
    ↓
Replace UI messages with summary message
    ↓
Delete old messages in local storage, save summary
    ↓
Reset message counter
```

---

## How to Test

### Quick Test
1. Enable **Auto-Summarization** in Settings
2. Set **Message Threshold** to **4** (minimum)
3. Enable **Compress History** toggle
4. Send 4 messages (2 user + 2 AI responses)
5. Observe: history should be replaced with summary
6. Continue conversation and verify AI uses summary context

### Comparison Test
1. Run same conversation twice:
   - First with Compress History = ON
   - Then with Compress History = OFF
2. Compare:
   - Token counts after summarization
   - Visibility of original messages
   - AI response quality for follow-up questions

See `COMPRESSION_TEST_SCENARIOS.md` for detailed test cases.

---

## Migration Notes

No database migrations required. The new `summarizationReplaceHistory` setting uses in-memory storage with a default value of `true`.

Existing users will:
- Get compression mode enabled by default
- Can switch to append mode in Settings if preferred

---

## API Compatibility

No changes to external API calls. The summarization feature uses existing:
- `ChatRepository.sendMessageWithCustomSystemPrompt()`
- `ChatRepository.initializeWithContext()`
- `ChatRepository.clearHistory()`
