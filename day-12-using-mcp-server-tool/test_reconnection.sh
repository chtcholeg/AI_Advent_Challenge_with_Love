#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è SSE reconnection fix
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./test_reconnection.sh

echo "======================================"
echo "SSE Reconnection Test Script"
echo "======================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è MCP —Å–µ—Ä–≤–µ—Ä–∞
if [ ! -d "SimpleMCPServer" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: SimpleMCPServer –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ MCP —Å–µ—Ä–≤–µ—Ä–∞
start_mcp_server() {
    echo "üöÄ –ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞..."
    cd SimpleMCPServer
    ./gradlew run --args="--no-auth" > ../mcp_server.log 2>&1 &
    MCP_PID=$!
    cd ..
    echo "   MCP —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID: $MCP_PID)"
    echo "   –õ–æ–≥–∏: mcp_server.log"

    # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
    echo "   –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (5 —Å–µ–∫—É–Ω–¥)..."
    sleep 5

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
    if kill -0 $MCP_PID 2>/dev/null; then
        echo "   ‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
        return 0
    else
        echo "   ‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
        cat mcp_server.log
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ MCP —Å–µ—Ä–≤–µ—Ä–∞
stop_mcp_server() {
    echo ""
    echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ MCP —Å–µ—Ä–≤–µ—Ä–∞ (PID: $MCP_PID)..."
    kill $MCP_PID 2>/dev/null
    wait $MCP_PID 2>/dev/null
    echo "   ‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
}

echo "üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:"
echo ""
echo "1. –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å—Ç–∏—Ç MCP —Å–µ—Ä–≤–µ—Ä"
echo "2. –í—ã –≤—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
echo "3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å MCP tool (–Ω–∞–ø—Ä–∏–º–µ—Ä 'What's the weather in London?')"
echo "4. –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç —Å–µ—Ä–≤–µ—Ä"
echo "5. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â–µ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ"
echo "6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ"
echo ""
read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∞..."

# –®–∞–≥ 1: –ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä–∞
start_mcp_server || exit 1

echo ""
echo "======================================"
echo "–®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
echo "======================================"
echo ""
echo "–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É:"
echo "  Desktop: ./gradlew :composeApp:run"
echo "  Android: ./gradlew :composeApp:installDebug && adb shell am start -n ru.chtcholeg.app/.MainActivity"
echo ""
read -p "–ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ..."

echo ""
echo "======================================"
echo "–®–∞–≥ 2: –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
echo "======================================"
echo ""
echo "–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:"
echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ MCP —Å–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω (Settings ‚Üí MCP)"
echo "2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: 'What's the weather in London?'"
echo "3. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–≤–µ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ–≥–æ–¥–µ"
echo ""
read -p "–ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ..."

echo ""
echo "======================================"
echo "–®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞"
echo "======================================"
echo ""
stop_mcp_server
sleep 2
start_mcp_server || exit 1

echo ""
echo "======================================"
echo "–®–∞–≥ 4: –í—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–µ—Å—Ç reconnect)"
echo "======================================"
echo ""
echo "–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:"
echo "1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â–µ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: 'What's the temperature in Paris?'"
echo "2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"
echo "3. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ—Ç–≤–µ—Ç–∞"
echo ""
echo "–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:"
echo "  ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
echo "  ‚úÖ –í –ª–æ–≥–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞: 'SSE: ‚úÖ Reconnection completed successfully'"
echo "  ‚úÖ –í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞ –ù–ï–¢ –æ—à–∏–±–æ–∫ 'ChannelWriteException'"
echo ""
read -p "–ù–∞–∂–º–∏—Ç–µ Enter –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è..."

echo ""
echo "======================================"
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞"
echo "======================================"
echo ""
echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞:"
echo "--------------------------------------"
tail -30 mcp_server.log | grep -E "INFO|ERROR|WARN"
echo "--------------------------------------"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
if grep -q "ChannelWriteException" mcp_server.log; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –ù–∞–π–¥–µ–Ω–∞ ChannelWriteException –≤ –ª–æ–≥–∞—Ö!"
    echo "   –§–∏–∫—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
else
    echo "‚úÖ –û—à–∏–±–æ–∫ ChannelWriteException –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    echo "   –§–∏–∫—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
fi

echo ""
echo "======================================"
echo "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞"
echo "======================================"
echo ""
read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –≤—ã—Ö–æ–¥–∞..."

stop_mcp_server

echo ""
echo "–ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: mcp_server.log"
echo ""
echo "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"
