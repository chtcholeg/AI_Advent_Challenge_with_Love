# GigaChat Мультиплатформенное Чат-Приложение (День 12 - Стабильность MCP и исправления)

Кроссплатформенное чат-приложение, созданное с помощью Kotlin Compose Multiplatform, интегрированное с GigaChat AI. Приложение работает на Android и Desktop (JVM).

## Обновление в Дне 12: Стабильность MCP и исправления ошибок

Эта версия фокусируется на **улучшениях стабильности и критических исправлениях** для интеграции MCP, представленной в Дне 11.

### Исправления ошибок

#### Стабильность SSE-соединений
- Исправлена ошибка ChannelWriteException при отключении клиентов
- Правильная обработка отмены корутин и закрытия соединений
- Чистые логи без спама ERROR для нормальных отключений
- Изменён цикл keepalive с `while (true)` на `while (coroutineContext.isActive)`

#### Сериализация вызовов функций
- Исправлены проблемы с парсингом и сериализацией JSON
- `FunctionCall.arguments` изменён с `String` на `JsonElement` (поддержка обоих форматов: объект и строка)
- Прямая передача JsonElement через цепочку выполнения (больше никаких ошибок сериализации `Map<String, Any>`)
- Результаты функций обёрнуты в JSON-формат: `{"result": "...", "is_error": false}`

#### Конфигурация таймаутов SSE
- Исправлена ошибка компиляции со значениями таймаутов
- Изменено `HttpTimeout.Long.MAX_VALUE` (не существует) на `36000000` (10 часов)
- Применено к Android и Desktop реализациям SSE-транспорта

#### Обработка ошибок
- Улучшена обработка исключений в SimpleMCPServer
- Глобальный обработчик StatusPages теперь игнорирует ожидаемые ChannelWriteException
- Добавлены специфические обработчики для CancellationException, IOException, ClosedReceiveChannelException
- Graceful degradation при ошибках подключения

### Изменённые файлы
- `SimpleMCPServer/src/main/kotlin/com/example/mcp/mcp/SseTransport.kt`
- `SimpleMCPServer/src/main/kotlin/com/example/mcp/Application.kt`
- `composeApp/src/commonMain/.../data/model/GigaChatFunction.kt`
- `composeApp/src/commonMain/.../data/repository/ChatRepositoryImpl.kt`
- `composeApp/src/commonMain/.../data/repository/McpRepository.kt`
- `composeApp/src/commonMain/.../data/repository/McpRepositoryImpl.kt`
- `composeApp/src/commonMain/.../data/mcp/McpClientManager.kt`
- `composeApp/src/androidMain/.../data/mcp/transport/SseTransportImpl.kt`
- `composeApp/src/desktopMain/.../data/mcp/transport/SseTransportImpl.kt`

## Предыдущее обновление (День 11): Интеграция MCP (Model Context Protocol) серверов

Эта версия представляет **Интеграцию MCP-серверов** - подключите ваш AI к внешним инструментам и источникам данных через протокол Model Context Protocol. AI теперь может вызывать внешние инструменты во время разговоров для получения информации или выполнения действий.

### Функции MCP

#### Интеграция внешних инструментов
- **Несколько типов транспорта**: Поддержка локальных (stdio) и удалённых (HTTP/SSE) MCP-серверов
- **Вызов функций**: AI может обнаруживать и вызывать MCP-инструменты через API вызова функций GigaChat
- **UI управления серверами**: Полнофункциональный экран управления для добавления, редактирования, включения/отключения серверов
- **Постоянное хранение**: Конфигурации MCP-серверов сохраняются в базу данных SQLDelight
- **Автоподключение**: Включённые серверы автоматически подключаются при запуске приложения
- **Кэширование инструментов**: Обнаруженные инструменты кэшируются для производительности
- **Кроссплатформенность**: Работает на Android и Desktop с платформо-специфичными транспортами

#### Типы серверов
- **Локальные (stdio)**: Запуск MCP-серверов как локальных процессов (рекомендуется для Desktop)
- **Удалённые (HTTP)**: Подключение к размещённым MCP-серверам с опциональной аутентификацией

#### Процесс вызова функций
1. Запрос к AI отправляется с доступными MCP-инструментами как функциями
2. Если AI хочет вызвать инструмент, finishReason = "function_call"
3. Инструмент выполняется через McpRepository
4. Результат добавляется в историю разговора
5. Рекурсивный вызов API для получения окончательного ответа
6. Общее время выполнения и токены отслеживаются по всем вызовам

### Преимущества функций Дня 11
- **Расширенные возможности**: AI может читать файлы, запрашивать базы данных, искать в интернете и многое другое
- **Гибкая интеграция**: Поддержка как локальных, так и удалённых серверов инструментов
- **Прозрачное использование**: AI автоматически решает, когда использовать инструменты
- **Удобное управление**: Добавление, редактирование и управление серверами через UI
- **Постоянная конфигурация**: Настройки серверов сохраняются между перезапусками приложения

### Компоненты MCP
- Доменные модели `McpServer`, `McpTool`, `McpToolResult`
- `McpLocalRepository` для постоянного хранения серверов
- `McpClientManager` для оркестрации подключений
- `McpRepository` для бизнес-логики
- `McpTransportFactory` (expect/actual) для создания платформо-специфичных транспортов
- `McpSettingsCard` краткое отображение статуса в Настройках
- `McpManagementScreen` полный интерфейс управления серверами
- `McpServerDialog` для добавления/редактирования конфигураций серверов

### Предыдущие функции (из Дня 10 - Сохранение истории)

#### Локальное хранилище в БД
- **Автосохранение**: Каждое сообщение автоматически сохраняется в локальную SQLite базу данных
- **Управление сессиями**: Сессии чата организованы и могут быть просмотрены
- **История сессий**: Просмотр всех предыдущих разговоров с временными метками
- **Поиск**: Найти разговоры по названию или содержимому сообщения
- **Архивирование**: Отметить разговоры как архивированные без удаления
- **Сохранение метаданных**: Время выполнения и количество токенов сохраняются с каждым сообщением

#### Сжатие диалога (День 9)
- **Умная суммаризация**: Автоматически сжимает разговоры при достижении порога сообщений
- **Ручное сжатие**: Нажмите кнопку создания/редактирования в любое время
- **Создание новой сессии**: Сжатие теперь создаёт новую сессию вместо удаления истории
- **Сохранение контекста**: AI использует резюме для умного продолжения разговора
- **Настраиваемый порог**: Установите порог сообщений от 4-50 (по умолчанию: 8)

### Предыдущие функции (из Дня 8)

#### Улучшения UI/UX
- Разбивка токенов с иконками-стрелками: "↑42 + ↓114" (↑=ввод, ↓=вывод)
- Название модели в заголовке приложения
- Автоматическая обрезка пробелов в ответах AI

#### Метаданные ответа (День 7)
- Каждый ответ AI показывает время выполнения запроса
- Формат: миллисекунды (ms) для быстрых ответов, секунды (s) для обычных
- Отображение использования токенов с разбивкой: токены запроса + токены ответа

### Предыдущие функции (из Дня 6)

#### Функции копирования сообщений
Полная интеграция с буфером обмена на всех платформах (Android, Desktop):
- Копирование отдельных сообщений одним кликом
- Копирование всей истории разговора в форматированный текст
- Кроссплатформенная поддержка через нативные API буфера обмена

#### Тестирование параметра температуры
Подробная документация в `QUESTIONS.md` для тестирования эффектов температуры.

### Предыдущие функции (из Дня 5)

#### Настройка сохранения истории чата
Переключатель в настройках, контролирующий поведение при смене режимов ответа:
- **ВЫКЛ (по умолчанию)**: История чата очищается при смене режима
- **ВКЛ**: История чата сохраняется, обновляется только системный промпт

#### Режим структурированного XML-ответа
Режим ответа, аналогичный JSON, но с использованием формата XML:
- AI отвечает в строгом XML-формате с резюме вопроса, ответом, ролью эксперта и unicode-символами
- Идеально для систем, предпочитающих XML вместо JSON

### Предыдущие функции (из Дня 4)

#### Режим пошагового рассуждения
При включении AI решает задачи, разбивая их на чёткие логические шаги. Идеально для:
- Математических вычислений
- Логических головоломок
- Аналитических вопросов
- Сложного принятия решений
- Обучения и понимания процессов

#### Режим экспертной панельной дискуссии
AI симулирует панель из 3-4 разнообразных экспертов, обсуждающих тему с разных точек зрения и формирующих консенсус. Идеально для:
- Получения разных мнений по теме
- Бизнес-решений
- Обсуждений технической архитектуры
- Карьерных советов
- Любой темы, требующей разносторонней экспертизы

## Архитектура

Проект следует архитектурному паттерну MVI (Model-View-Intent):

- **Model**: Неизменяемые модели данных, представляющие состояние приложения
- **View**: Compose UI компоненты, отображающие состояние
- **Intent**: Действия пользователя, вызывающие изменения состояния
- **Store**: Центральное управление состоянием, обрабатывающее намерения и обновляющее состояние

### Технологический стек

- **Kotlin Multiplatform**: Общий код для всех платформ
- **Compose Multiplatform**: UI фреймворк
- **Ktor**: HTTP клиент для API запросов
- **Kotlinx Serialization**: Сериализация/десериализация JSON
- **Kotlinx Coroutines**: Асинхронное программирование
- **Koin**: Внедрение зависимостей
- **SQLDelight**: Кроссплатформенная SQLite база данных
- **GigaChat API**: AI чатбот бэкенд с поддержкой вызова функций

## Структура проекта

```
day-11-connecting-mcp-server/
├── composeApp/
│   └── src/
│       ├── commonMain/          # Общий код
│       │   └── kotlin/
│       │       └── ru/chtcholeg/app/
│       │           ├── data/           # Слой данных
│       │           │   ├── api/        # Реализации API
│       │           │   ├── local/      # Локальная БД
│       │           │   ├── mcp/        # MCP клиент (НОВОЕ в Дне 11)
│       │           │   │   ├── stub/   # Заглушка MCP SDK
│       │           │   │   └── McpClientManager.kt
│       │           │   ├── model/      # DTO
│       │           │   └── repository/ # Репозитории
│       │           ├── domain/         # Бизнес-логика
│       │           │   ├── model/      # Доменные модели
│       │           │   └── usecase/    # Use cases
│       │           ├── presentation/   # UI слой (MVI)
│       │           │   ├── chat/       # Экран чата
│       │           │   ├── session/    # Список сессий
│       │           │   ├── settings/   # Настройки
│       │           │   │   └── mcp/    # Управление MCP (НОВОЕ в Дне 11)
│       │           │   ├── components/ # Переиспользуемые UI
│       │           │   └── theme/      # Material Design 3
│       │           ├── di/             # Внедрение зависимостей
│       │           └── util/           # Утилиты
│       ├── androidMain/         # Android-специфичный код
│       └── desktopMain/         # Desktop-специфичный код
├── gradle/
├── build.gradle.kts
├── settings.gradle.kts
├── README.md
├── README_RU.md
├── CLAUDE.md
├── DIFF_10-11.md          # Журнал изменений между Днём 10 и Днём 11
├── MCP_GUIDE.md           # Руководство по интеграции MCP (НОВОЕ в Дне 11)
└── QUESTIONS.md           # Руководство по тестированию температуры
```

## Требования

Перед началом убедитесь, что у вас установлено:

- **JDK 17 или выше**: Требуется для Kotlin и Gradle
- **Android Studio**: Для Android-разработки и сборки
- **IntelliJ IDEA** (опционально): Рекомендуется для мультиплатформенной разработки
- **Android SDK**: Для Android-сборок (можно установить через Android Studio)

## Получение учётных данных GigaChat API

Для использования приложения вам нужны учётные данные GigaChat API:

1. Посетите [GigaChat Developer Portal](https://developers.sber.ru/portal/products/gigachat)
2. Зарегистрируйтесь или войдите в свой аккаунт
3. Создайте новое приложение/проект
4. Получите **Client ID** и **Client Secret**

## Инструкции по настройке

### 1. Клонирование или скачивание проекта

```bash
cd /Users/shchepilov/AndroidStudioProjects/AI_Advent_Challenge_with_Love/day-11-connecting-mcp-server
```

### 2. Настройка учётных данных API

Приложение использует Gradle properties для безопасного управления учётными данными.

1. Скопируйте файл-шаблон:
   ```bash
   cp local.properties.template local.properties
   ```

2. Отредактируйте `local.properties` и добавьте свои учётные данные GigaChat:
   ```properties
   gigachat.clientId=ваш_client_id
   gigachat.clientSecret=ваш_client_secret
   ```

   **Важно:** Файл `local.properties` автоматически исключён из системы контроля версий (указан в `.gitignore`), поэтому ваши учётные данные останутся в безопасности.

### 3. Сборка проекта

```bash
./gradlew build
```

Плагин BuildKonfig сгенерирует конфигурационные константы из вашего файла `local.properties` во время сборки.

## Запуск приложения

### Android

#### Способ 1: Командная строка

```bash
# Установка на подключённое устройство или эмулятор
./gradlew :composeApp:installDebug

# Запуск приложения
adb shell am start -n ru.chtcholeg.app/.MainActivity
```

#### Способ 2: Android Studio

1. Откройте проект в Android Studio
2. Убедитесь, что `local.properties` настроен с вашими учётными данными
3. Выберите Android-устройство или эмулятор
4. Нажмите кнопку **Run** (или `Shift + F10`)

### Desktop (JVM)

```bash
# Запуск desktop-приложения
./gradlew :composeApp:runDesktop
```

**Альтернатива:** Запуск из IntelliJ IDEA:
1. Откройте проект в IntelliJ IDEA
2. Убедитесь, что `local.properties` настроен с вашими учётными данными
3. Запустите desktop main функцию (Shift + F10)

## Сборка распространяемых пакетов

### Android APK

```bash
# Debug APK
./gradlew :composeApp:assembleDebug

# Release APK (требуется настройка подписи)
./gradlew :composeApp:assembleRelease

# Результат: composeApp/build/outputs/apk/
```

### Desktop-установщики

```bash
# Пакет для текущей ОС
./gradlew :composeApp:packageDistributionForCurrentOS

# Результат:
# - macOS: composeApp/build/compose/binaries/main/dmg/
# - Windows: composeApp/build/compose/binaries/main/msi/
# - Linux: composeApp/build/compose/binaries/main/deb/
```

## Функции

- Чат в реальном времени с GigaChat AI и моделями HuggingFace
- **Интеграция MCP-серверов** (НОВОЕ в Дне 11):
  - Подключение к внешним MCP-серверам (локальные stdio или удалённые HTTP)
  - AI может вызывать инструменты с подключённых серверов
  - Полный UI управления серверами
  - Постоянные конфигурации серверов
  - Кроссплатформенная поддержка
- **Локальное сохранение истории чата** (День 10):
  - SQLite база данных для персистентного сохранения сессий
  - Автосохранение каждого сообщения с полными метаданными
  - Просмотр всех предыдущих сессий чата
  - Восстановление любого разговора в любое время
  - Поиск сессий по названию или содержимому
  - Архивирование старых разговоров
- **Улучшенное сжатие диалога** (День 9):
  - Умная суммаризация при настраиваемом пороге сообщений
  - Ручное сжатие через кнопку создания/редактирования
  - Создание новой сессии вместо удаления истории
  - Оригинальные разговоры сохраняются в истории сессий
- **Улучшения UI/UX** (День 8):
  - Разбивка токенов с иконками-стрелками
  - Название модели в заголовке приложения
  - Автоматическая обрезка пробелов в ответах AI
- **Метаданные ответа** (День 7):
  - Отображение времени выполнения для каждого ответа AI
  - Разбивка использования токенов (запрос + ответ)
- **Копирование сообщений** (День 6):
  - Копирование отдельных сообщений одним кликом
  - Копирование всей истории разговора
  - Кроссплатформенная поддержка буфера обмена
- **Тестирование параметра температуры** (День 6):
  - Подробное руководство с тестовыми вопросами
- **Сохранение истории чата при смене системного промпта** (День 5)
- **Режим структурированного XML-ответа** (День 5)
- **Режим пошагового рассуждения** (День 4)
- **Режим экспертной панельной дискуссии** (День 4)
- **Режим диалога** - Интерактивный сбор требований
- **Режим структурированного JSON-ответа**
- Кроссплатформенная поддержка (Android, Desktop)
- Чистая MVI архитектура
- Управление историей разговора
- Обработка ошибок с функцией повтора
- Индикаторы загрузки
- Временные метки сообщений
- Функция очистки чата
- Настраиваемые параметры AI (температура, top-p, max tokens, repetition penalty)
- Поддержка нескольких AI-моделей (GigaChat, Llama, DeepSeek)

## Использование MCP-серверов

См. [MCP_GUIDE.md](MCP_GUIDE.md) для подробных инструкций по:
- Добавлению локальных и удалённых MCP-серверов
- Настройке параметров серверов
- Популярным примерам MCP-серверов
- Устранению проблем с подключением
- Лучшим практикам безопасности и производительности

## Устранение неполадок

### Синхронизация Gradle не работает

```bash
./gradlew clean
./gradlew --refresh-dependencies
```

### Учётные данные не найдены или пусты

**Симптом:** Пустые учётные данные или ошибки сборки, связанные с отсутствующей конфигурацией

**Решение:**
- Убедитесь, что `local.properties` существует в корневой директории проекта
- Проверьте правильность имён свойств: `gigachat.clientId` и `gigachat.clientSecret`
- Убедитесь, что значения не пусты в `local.properties`
- Запустите `./gradlew clean` и пересоберите проект

### Проблемы подключения MCP-серверов

**Симптом:** Сервер показывает статус "Error" или инструменты недоступны

**Решение:**
- Для локальных серверов: Проверьте правильность команды и аргументов
- Для HTTP-серверов: Проверьте URL и токен аутентификации
- Убедитесь, что выбрана модель GigaChat (вызов функций не поддерживается на HuggingFace)
- См. MCP_GUIDE.md для подробного устранения неполадок

### Сборка Android не работает

**Проверьте:**
- Android SDK установлен и `ANDROID_HOME` настроен
- Версия Target SDK соответствует установленному SDK
- Запустите `./gradlew :composeApp:dependencies` для проверки конфликтов

### Сборка Desktop не работает

**Проверьте:**
- Версия JDK 17 или выше: `java -version`
- `JAVA_HOME` настроен правильно
- Попробуйте запустить с `--stacktrace` для подробностей

## Конфигурация проекта

### Выбор режима ответа

Приложение имеет шесть различных режимов ответа, доступных через выпадающее меню в Настройках:

1. **Normal Mode** (по умолчанию): Стандартные разговорные ответы AI
2. **Structured JSON Response**: AI возвращает данные в строгом JSON-формате
3. **Structured XML Response**: AI возвращает данные в строгом XML-формате
4. **Dialog Mode**: AI задаёт уточняющие вопросы для сбора информации
5. **Step-by-Step Reasoning**: AI решает задачи пошагово
6. **Expert Panel Discussion**: AI симулирует обсуждение экспертной панели

### Настройка MCP-серверов

1. Откройте Настройки из экрана чата
2. Нажмите на карточку **MCP Servers**
3. Нажмите **+** для добавления нового сервера
4. Выберите тип сервера (Local или HTTP)
5. Введите данные конфигурации
6. Включите сервер для подключения

### Смена AI-модели

Перейдите в Настройки и выберите из доступных моделей:
- GigaChat (Сбербанк) - Поддерживает вызов функций
- Llama 3.2 3B Instruct (HuggingFace)
- Meta Llama 3 70B Instruct (HuggingFace)
- DeepSeek V3 (HuggingFace)

**Примечание:** Только модели GigaChat поддерживают вызов MCP-инструментов.

### Настройка параметров AI

Редактируйте настройки в UI приложения:
- Temperature (0.0-2.0): Контролирует случайность
- Top P (0.0-1.0): Порог nucleus sampling
- Max Tokens (1-8192): Лимит длины ответа
- Repetition Penalty (0.0-2.0): Уменьшает повторения

## Разработка

### Добавление новых функций

1. **Data Layer**: Добавьте модели, методы API, методы репозитория
2. **Domain Layer**: Создайте use cases для бизнес-логики
3. **Presentation Layer**: Определите новые intents и обновите состояние
4. **UI Layer**: Создайте composable компоненты

### Запуск тестов

```bash
./gradlew test
```

### Стиль кода

Проект следует [Официальному стилю кода Kotlin](https://kotlinlang.org/docs/coding-conventions.html).

## Лицензия

Этот проект создан в образовательных целях.

## Контакты

По вопросам и проблемам обращайтесь к документации GigaChat API:
- [GigaChat API Docs](https://developers.sber.ru/docs/ru/gigachat/api/overview)

## Файлы документации

Проект включает подробную документацию:

- **README.md** - Полное руководство по настройке и использованию (английский)
- **README_RU.md** (этот файл) - Полное руководство по настройке и использованию (русский)
- **CLAUDE.md** - Техническая документация для интеграции с Claude Code
- **DIFF_10-11.md** - Подробный журнал изменений между Днём 10 и Днём 11 (Интеграция MCP)
- **MCP_GUIDE.md** - Руководство по интеграции MCP-серверов (НОВОЕ в Дне 11)
- **QUESTIONS.md** - Руководство по тестированию параметра температуры

## Благодарности

- Создано с [Kotlin Multiplatform](https://kotlinlang.org/docs/multiplatform.html)
- UI на базе [Compose Multiplatform](https://www.jetbrains.com/lp/compose-multiplatform/)
- AI от [GigaChat](https://developers.sber.ru/portal/products/gigachat)
- MCP протокол от [Model Context Protocol](https://modelcontextprotocol.io)

## Видео

- https://disk.yandex.ru/i/-xKKVH1NWKyaJw
